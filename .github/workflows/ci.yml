name: Do the thing in CI

on:
  push:
    branches: ["master", "proc-smaps"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  run:
    strategy:
      fail-fast: false
      matrix:
        build:
          - assembly
          - bun
          - c-gcc
          - c-clang
          - cpp-gcc
          - cpp-clang
          - cobol
          - coffeescript
          - crystal
          - csharp
          - deno
          - erlang
          - forth
          - fortran
          - go
          - haskell
          - java
          - julia
          - kotlin
          - lua
          - nim
          - node
          - pascal
          - perl
          - php
          - prolog
          - python3
          - ruby
          - rust
          - scala
          - smalltalk
          # - tcl
          - zig
    runs-on: ubuntu-latest
    container:
      image: acheronfail/count
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # really github? why do you override $HOME?
      # https://github.com/actions/runner/issues/863
      - run: 'echo HOME=/root >> $GITHUB_ENV'
      # do the thing
      - run: just test    ${{ matrix.build }}
      - run: just measure ${{ matrix.build }}
      # report
      - uses: actions/upload-artifact@v3
        with:
          path: "results/${{ matrix.build }}.json"

  report:
    needs: ["run"]
    runs-on: ubuntu-latest
    permissions:
      # needed for creating the github release
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Download Results
        uses: actions/download-artifact@v3
        with:
          path: .
      - run: sudo apt-get update && sudo apt-get install -y nodejs
      - name: Generate Summary
        run: |
          cd scripts
          npm start -- --results ../artifact
          cat summary.md
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.run_number }}
          body_path: scripts/summary.md
          files: artifact/*.json
          draft: ${{ github.ref_name != 'master' }}
          prerelease: ${{ github.ref_name != 'master' }}
