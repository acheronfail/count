name: Do the thing in CI

on:
  push:
    branches: ['master']

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  run:
    strategy:
      fail-fast: false
      matrix:
        # do the slow ones first, to make the overall build quicker
        build:
          # - 00 tcl
          - 01 prolog
          - 02 smalltalk
          - 03 python3
          - 04 julia
          - 05 perl
          - 06 cobol
          - 07 haskell
          - 08 ruby
          - 09 forth
          - 10 lua
          - 11 php
          - 12 erlang
          - 13 crystal
          - 14 scala
          - 15 csharp
          - 16 coffeescript
          - 17 kotlin
          - 18 java
          - 19 deno
          - 20 node
          - 21 go
          - 22 bun
          - 23 fortran
          - 24 rust
          - 25 cpp-clang
          - 26 cpp-gcc
          - 27 c-clang
          - 28 c-gcc
          - 29 nim
          - 30 pascal
          - 31 zig
          - 32 assembly
    runs-on: ubuntu-latest
    container:
      image: acheronfail/count
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # really github? why do you override $HOME?
      # https://github.com/actions/runner/issues/863
      - run: 'echo HOME=/root >> $GITHUB_ENV'
      # do the thing
      - run: just test    ${{ matrix.build }}
      - run: just measure ${{ matrix.build }}
      # report
      - uses: actions/upload-artifact@v3
        with:
          path: 'results/${{ matrix.build }}.json'

  report:
    needs: ['run']
    runs-on: ubuntu-latest
    permissions:
      # needed for creating the github release
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Download Results
        uses: actions/download-artifact@v3
        with:
          path: .
      - run: sudo apt-get update && sudo apt-get install -y nodejs
      - name: Generate Summary
        run: |
          cd scripts
          npm start -- --results ../artifact
          cat summary.md
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.run_number }}
          body_path: scripts/summary.md
          files: artifact/*.json
          draft: ${{ github.ref_name != 'master' }}
          prerelease: ${{ github.ref_name != 'master' }}
