name: Do the thing in CI

on:
  push:
    branches: ['master']

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  run:
    strategy:
      fail-fast: false
      matrix:
        # do the slow ones first, to make the overall build quicker
        build:
          # - 00_tcl
          - 01_prolog
          - 02_smalltalk
          - 03_python3
          - 04_julia
          - 05_perl
          - 06_cobol
          - 07_haskell
          - 08_ruby
          - 09_forth
          - 10_lua
          - 11_ocaml
          - 12_php
          - 13_erlang
          - 14_crystal
          - 15_scala
          - 16_csharp
          - 17_coffeescript
          - 18_kotlin
          - 19_java
          - 20_deno
          - 21_node
          - 22_go
          - 23_bun
          - 24_fortran
          - 25_rust
          - 26_cpp-clang
          - 27_cpp-gcc
          - 28_c-clang
          - 29_c-gcc
          - 30_nim
          - 31_pascal
          - 32_zig
          - 33_assembly
          - 34_ocaml
    runs-on: ubuntu-latest
    container:
      image: acheronfail/count
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      # really github? why do you override $HOME?
      # https://github.com/actions/runner/issues/863
      - name: Setup environment
        run: |
          echo HOME=/root >> $GITHUB_ENV
          WHAT=${{ matrix.build }}
          echo WHAT=${WHAT##*_} >> $GITHUB_ENV
      # do the thing
      - run: just test    ${{ env.WHAT }}
      - run: just measure ${{ env.WHAT }}
      # report
      - uses: actions/upload-artifact@v3
        with:
          path: 'results/${{ env.WHAT }}.json'

  report:
    needs: ['run']
    runs-on: ubuntu-latest
    permissions:
      # needed for creating the github release
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Download Results
        uses: actions/download-artifact@v3
        with:
          path: .
      - run: sudo apt-get update && sudo apt-get install -y nodejs
      - name: Generate Summary
        run: |
          cd scripts
          npm start -- --results ../artifact
          cat summary.md
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.run_number }}
          body_path: scripts/summary.md
          files: artifact/*.json
          draft: ${{ github.ref_name != 'master' }}
          prerelease: ${{ github.ref_name != 'master' }}
